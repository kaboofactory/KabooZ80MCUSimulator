; ============================================================================
; COMPREHENSIVE Z80 VERIFICATION SUITE (Z80 CPU命令 総合検証テスト)
; Based on instruction_set.html
; ============================================================================
;
; このプログラムは、シミュレータのZ80 CPUコア実装が正しいかを検証するための一連のテストです。
; 各セクションで特定の命令グループ（ロード、算術演算、論理演算など）を実行し、
; 結果が期待通りかどうかをチェックします。
;
; ■ テスト結果の表示
; 
;   [成功時 (SUCCESS)]
;     - 緑色LED点灯 (Port 0x00, Bit 0)
;     - 7セグメントディスプレイに 'P' (Pass) を表示 (Port 0x17)
;
;   [失敗時 (FAILURE)]
;     - 赤色LED点灯 (Port 0x00, Bit 7)
;     - 7セグメントディスプレイに失敗したセクション番号を表示 (Port 0x10)
; ============================================================================

    ORG 0x0000
    JP START

; ----------------------------------------------------------------------------
; 成功時の処理
; ----------------------------------------------------------------------------
SUCCESS:
    LD A, 0x01
    OUT (0x00), A   ; 緑LED点灯
    LD A, 0x73      ; 'P' のセグメントパターン
    OUT (0x17), A   ; 右端の7セグに表示
    HALT            ; 停止

; ----------------------------------------------------------------------------
; 失敗時の処理 (AレジスタにエラーIDを入れてジャンプ)
; ----------------------------------------------------------------------------
ERROR:
    OUT (0x10), A   ; エラーIDを左端の7セグに表示
    LD A, 0x80
    OUT (0x00), A   ; 赤LED点灯
    HALT            ; 停止

; ----------------------------------------------------------------------------
; メインテストシーケンス
; ----------------------------------------------------------------------------
START:
    LD SP, 0xFFFF   ; スタック初期化

    ; --------------------------------------------------------
    ; SECTION 1: 8-BIT LOADS (8ビット転送命令)
    ; --------------------------------------------------------
    LD A, 0x11 : CP 0x11 : JP NZ, FAIL_1        ; 即値ロード
    LD B, A : LD A, B : CP 0x11 : JP NZ, FAIL_1 ; レジスタ間転送
    LD HL, 0x8000 : LD (HL), 0x55 : LD A, (HL) : CP 0x55 : JP NZ, FAIL_1 ; メモリ間接
    LD IX, 0x8010 : LD (IX+2), 0xAA : LD A, (IX+2) : CP 0xAA : JP NZ, FAIL_1 ; インデックス修飾

    ; --------------------------------------------------------
    ; SECTION 2: 16-BIT LOADS (16ビット転送命令)
    ; --------------------------------------------------------
    LD BC, 0x1234 : LD DE, 0x5678               ; 16ビット即値
    LD HL, 0x9ABC : LD (0x8020), HL : LD HL, 0 : LD HL, (0x8020) ; 16ビット直接
    LD A, H : CP 0x9A : JP NZ, FAIL_2
    PUSH BC : POP DE : LD A, D : CP 0x12 : JP NZ, FAIL_2 ; スタック操作

    ; --------------------------------------------------------
    ; SECTION 3: EXCHANGE & BLOCK (交換・ブロック転送)
    ; --------------------------------------------------------
    EX DE, HL : LD A, D : CP 0x9A : JP NZ, FAIL_3 ; 交換
    ; LDI (Load Increment)
    LD HL, 0x8030 : LD DE, 0x8031 : LD (HL), 0x99 : LD BC, 1 : LDI : LD A, (0x8031) : CP 0x99 : JP NZ, FAIL_3
    ; CPIR (Compare Increment Repeat)
    LD HL, 0x8040 : LD (HL), 0x10 : INC HL : LD (HL), 0x20 : LD HL, 0x8040 : LD BC, 5 : LD A, 0x20 : CPIR : JP NZ, FAIL_3

    ; --------------------------------------------------------
    ; SECTION 4: ARITHMETIC (算術演算)
    ; --------------------------------------------------------
    LD A, 10 : ADD A, 20 : CP 30 : JP NZ, FAIL_4 ; 加算
    LD A, 5 : INC A : CP 6 : JP NZ, FAIL_4       ; インクリメント
    NEG : CP 0xFA : JP NZ, FAIL_4                ; 符号反転 (2の補数: -6 = 0xFA)

    ; --------------------------------------------------------
    ; SECTION 5: LOGICAL (論理演算)
    ; --------------------------------------------------------
    LD A, 0xF0 : AND 0x0F : CP 0 : JP NZ, FAIL_5 ; AND
    XOR A : CP 0 : JP NZ, FAIL_5                 ; XOR (ゼロクリア)

    ; --------------------------------------------------------
    ; SECTION 6: ROTATE & SHIFT (回転・シフト)
    ; --------------------------------------------------------
    LD A, 0x80 : RLCA : CP 0x01 : JP NZ, FAIL_6  ; 左回転 (Bit7 -> Bit0)
    LD C, 0x01 : RRC C : LD A, C : CP 0x80 : JP NZ, FAIL_6 ; 右回転 (Bit0 -> Bit7)

    ; --------------------------------------------------------
    ; SECTION 7: BIT OPS (ビット操作)
    ; --------------------------------------------------------
    LD E, 0 : SET 4, E : BIT 4, E : JP Z, FAIL_7 ; ビットセット & テスト
    RES 4, E : LD A, E : CP 0 : JP NZ, FAIL_7    ; ビットリセット

    ; --------------------------------------------------------
    ; SECTION 8: JUMPS (ジャンプ・ループ)
    ; --------------------------------------------------------
    JR SKIP_JR      ; 相対ジャンプ
    JP FAIL_8       ; ここに来たら失敗
SKIP_JR:
    LD B, 3 : LD A, 0
LOOP_B: INC A : DJNZ LOOP_B : CP 3 : JP NZ, FAIL_8 ; DJNZループ

    ; --------------------------------------------------------
    ; SECTION 9: STACK (スタック操作詳細)
    ; --------------------------------------------------------
    LD HL, 0xABCD : PUSH HL : LD HL, 0 : EX (SP), HL : LD A, H : CP 0xAB : JP NZ, FAIL_9 : POP HL

    ; 全テスト通過
    JP SUCCESS

; ----------------------------------------------------------------------------
; 失敗ハンドラ定義
; ----------------------------------------------------------------------------
FAIL_1: LD A, 1 : JP ERROR
FAIL_2: LD A, 2 : JP ERROR
FAIL_3: LD A, 3 : JP ERROR
FAIL_4: LD A, 4 : JP ERROR
FAIL_5: LD A, 5 : JP ERROR
FAIL_6: LD A, 6 : JP ERROR
FAIL_7: LD A, 7 : JP ERROR
FAIL_8: LD A, 8 : JP ERROR
FAIL_9: LD A, 9 : JP ERROR
