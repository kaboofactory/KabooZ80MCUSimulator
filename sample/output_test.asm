; ============================================================================
; OUTPUT DEVICE TEST (出力デバイス総合テスト)
; ============================================================================
;
; このプログラムは、KabooZ80 Simulator に接続された下記の出力デバイスを
; 順次制御して動作確認を行うデモプログラムです。
;
; 1. LED (Port 0x00)          : 2進数カウンタ (0-255)
; 2. 7-Segment (Port 0x10-17) : 値のシフト表示テスト
; 3. LCD 16x2 (Port 0x20,21)  : ランダム文字出力 + 左スクロール (2行表示)
; 4. Dot Matrix (Port 0x80-9F): パターンアニメーション
; 5. Buzzer (Port 0x30)       : 1秒ごとのトーン出力 (※デフォルトでコメントアウト)
;
; ============================================================================

    ORG 0x0000
    JP START

    ; --- 割り込みベクタ (現在は未使用ですが、配置場所を確保) ---
    ORG 0x0038
    RETI

; ----------------------------------------------------------------------------
; 定数定義 (CONSTANTS)
; ----------------------------------------------------------------------------
PORT_LED        EQU 0x00    ; 8連LED
PORT_7SEG_BASE  EQU 0x10    ; 7セグメントディスプレイ (8桁: 0x10-0x17)
PORT_LCD_CMD    EQU 0x20    ; LCD コマンドポート
PORT_LCD_DAT    EQU 0x21    ; LCD データポート
PORT_BUZZER     EQU 0x30    ; 圧電ブザー
PORT_KEYPAD     EQU 0x40    ; キーパッド (入力)
PORT_DIP_BASE   EQU 0x50    ; DIPスイッチ (入力)
PORT_BTN        EQU 0x60    ; 割り込みボタン
PORT_MATRIX_BASE EQU 0x80   ; ドットマトリクス (16行x2)
PORT_RTC_SEC    EQU 0xC0    ; リアルタイムクロック (秒)

; ----------------------------------------------------------------------------
; メインプログラム (MAIN PROGRAM)
; ----------------------------------------------------------------------------
    ORG 0x0100
START:
    LD SP, 0xFFFF           ; スタックポインタ初期化
    
    ; --- LCD初期化 ---
    LD A, 0x01              ; Clear Display コマンド
    OUT (PORT_LCD_CMD), A
    
    ; --- 変数初期化 ---
    XOR A
    LD (VAR_LED), A
    LD (VAR_7SEG), A
    LD (VAR_LCD_IDX), A
    LD (VAR_MAT_STEP), A
    LD (VAR_BUZZ_TONE), A
    
    ; --- 乱数シード初期化 ---
    ; メモリ末尾で定義されたDW値(RNG_SEED)を使用するため、
    ; ここでのハードコード初期化は行いません。
    ; LD HL, 0xACE1
    ; LD (RNG_SEED), HL

MAIN_LOOP:
    ; --------------------------------------------------------
    ; 1. LED 更新 (2進数カウンタ)
    ; --------------------------------------------------------
    LD A, (VAR_LED)
    INC A
    LD (VAR_LED), A
    OUT (PORT_LED), A       ; ポート0へ出力

    ; --------------------------------------------------------
    ; 2. 7セグメント 更新 (シフト表示)
    ; --------------------------------------------------------
    CALL UPDATE_7SEG

    ; --------------------------------------------------------
    ; 3. LCD 更新 (ランダム文字・スクロール)
    ; --------------------------------------------------------
    CALL UPDATE_LCD

    ; --------------------------------------------------------
    ; 4. ドットマトリクス 更新 (アニメーション)
    ; --------------------------------------------------------
    CALL UPDATE_MATRIX

    ; --------------------------------------------------------
    ; 5. ブザー 更新
    ; --------------------------------------------------------
    ; ※ 音が出るため、必要に応じてコメントアウトを解除してください
    ; CALL UPDATE_BUZZER

    ; --------------------------------------------------------
    ; ウェイト処理 (目視できるように遅延を入れる)
    ; --------------------------------------------------------
    CALL DELAY_MS
    
    JP MAIN_LOOP            ; 無限ループ

; ----------------------------------------------------------------------------
; サブルーチン (SUBROUTINES)
; ----------------------------------------------------------------------------

; --- 7セグメント更新 ---
; VAR_LED の値を少しずつずらしながら8桁に表示します
UPDATE_7SEG:
    LD HL, VAR_LED
    LD A, (HL)
    LD B, A                 ; ベース値
    
    LD C, PORT_7SEG_BASE    ; 最初の桁 (0x10)
    LD D, 8                 ; 8桁分ループ
U7_LOOP:
    LD A, B
    OUT (C), A              ; 出力
    ADD A, 32               ; 次の桁のために値をずらす (デモ用演出)
    LD B, A
    INC C                   ; 次のポートへ
    DEC D
    JR NZ, U7_LOOP
    RET

; --- LCD更新 ---
; 画面全体を左にシフトし、右端に新しいランダム文字を追加します
UPDATE_LCD:
    ; 1. 画面全体を左にシフト (Cursor or Display Shift コマンド)
    LD A, 0x18              ; 0001 10xx (S/C=1:Display, R/L=0:Left)
    OUT (PORT_LCD_CMD), A
    
    ; 2. 1行目の右端へカーソル移動
    ; DDRAM Address Set 0x80 | Address
    ; 1行目の末尾は 0x0F (16文字目) ですが、シフトされているため
    ; 仮想的な右端に書き込むことでティッカー表示になります。
    LD A, 0x8F              ; 0x80 + 0x0F
    OUT (PORT_LCD_CMD), A

    ; 3. ランダムな文字を生成して書き込み (1行目)
    CALL RAND
    AND 0x3F                ; 0-63 に制限
    ADD A, 0x20             ; +32 (ASCII 0x20 Space ～ 0x5F '_')
    OUT (PORT_LCD_DAT), A   ; データ書き込み
    
    ; 4. 2行目の右端へカーソル移動
    ; 2行目の先頭アドレスは 0x40 なので、2行目末尾は 0x4F
    LD A, 0xCF              ; 0x80 + 0x4F
    OUT (PORT_LCD_CMD), A
    
    ; 5. ランダムな文字を生成して書き込み (2行目)
    CALL RAND
    AND 0x3F
    ADD A, 0x20
    OUT (PORT_LCD_DAT), A
    
    RET

; --- マトリクス更新 ---
; VAR_MAT_STEP に応じて市松模様をアニメーションさせます
UPDATE_MATRIX:
    LD A, (VAR_MAT_STEP)
    INC A
    AND 0x0F                ; 0-15 でループ
    LD (VAR_MAT_STEP), A
    
    LD B, 0                 ; 行カウンタ
    LD C, PORT_MATRIX_BASE  ; ポート 0x80 から開始
MAT_LOOP:
    LD A, (VAR_MAT_STEP)
    ADD A, B                ; ステップ数 + 行番号
    AND 1                   ; 偶数か奇数か
    JR Z, MAT_ODD
    LD A, 0xAA              ; 10101010 (偶数パタン)
    JR MAT_SET
MAT_ODD:
    LD A, 0x55              ; 01010101 (奇数パタン)
MAT_SET:
    OUT (C), A              ; 左側8ドット出力
    INC C
    OUT (C), A              ; 右側8ドット出力 (同じパタン)
    INC C
    INC B                   ; 次の行へ
    LD A, B
    CP 16
    JR NZ, MAT_LOOP
    RET

; --- ブザー更新 ---
; RTCの秒が変わるたびにトーンを変更します
UPDATE_BUZZER:
    IN A, (PORT_RTC_SEC)    ; 現在の秒を取得
    LD HL, LAST_SEC
    CP (HL)
    RET Z                   ; 秒が変わっていなければ何もしない
    
    ; 秒が変わった
    LD (HL), A              ; 現在秒を保存
    
    ; トーン変更 (周波数パラメータ)
    LD A, (VAR_BUZZ_TONE)
    ADD A, 10
    LD (VAR_BUZZ_TONE), A
    
    ; ブザーポートに出力
    OUT (PORT_BUZZER), A
    RET

; --- ウェイト (簡易遅延) ---
DELAY_MS:
    LD BC, 0x2000           ; ループ回数 (クロック周波数に依存します)
DLY:
    DEC BC
    LD A, B
    OR C
    JR NZ, DLY
    RET

; --- 乱数生成 (Xorshift / LFSR) ---
RAND:
    LD HL, (RNG_SEED)
    INC HL                  ; パターン固定化防止のインクリメント
    LD A, H
    RLCA                    ; 左回転
    XOR L
    RLCA
    XOR H
    LD H, L
    LD L, A
    LD (RNG_SEED), HL
    RET

; ----------------------------------------------------------------------------
; 変数・ワークエリア (VARIABLES)
; ----------------------------------------------------------------------------
VAR_LED:        DB 0
VAR_7SEG:       DB 0
VAR_LCD_IDX:    DB 0  ; (未使用)
VAR_MAT_STEP:   DB 0  ; アニメーション用ステップ
VAR_BUZZ_TONE:  DB 0  ; 現在のブザートーン
LAST_SEC:       DB 0  ; RTC秒保存用
RNG_SEED:       DW 0x1234 ; 乱数シード (ここを変更すると乱数系列が変わります)
